<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Race Ranking - Results</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 {
      text-align: center;
      margin-bottom: 10px;
    }
    .nav {
      text-align: center;
      margin-bottom: 20px;
    }
    .nav a {
      margin: 0 10px;
      text-decoration: none;
      color: #1976d2;
      font-weight: bold;
    }
    .section {
      background: #ffffff;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      max-width: 1000px;
      margin: 0 auto;
    }
    .section h2 {
      margin-top: 0;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }
        .actions-bar {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 10px;
      gap: 10px;
    }

    .btn {
      padding: 6px 12px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }

    .btn-export {
      background: #2e7d32;
      color: #fff;
    }

    .btn-export:disabled {
      opacity: 0.6;
      cursor: default;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 0.9rem;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 6px 8px;
      text-align: left;
      white-space: nowrap;
    }
    th {
      background: #f0f0f0;
    }
    tbody tr:nth-child(even) {
      background: #fafafa;
    }
    .center {
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>Race Ranking</h1>
  <div class="nav">
    <a href="index.html">Results</a>
    <a href="input.html">Add Race</a>
  </div>

  <div class="section">
    <h2>RESULTS</h2>
    <table>
<thead>
  <tr>
    <th>Date</th>
    <th>Event Name</th>
    <th>City</th>
    <th>Country</th>
    <th>Distance</th>
    <th>Time</th>
    <th>Pace (min/km)</th>
    <th>Actions</th>
  </tr>
</thead>

      <tbody id="results-body">
        <!-- Filled dynamically -->
      </tbody>
    </table>
    <br>
        <div class="actions-bar">
      <button id="export-btn" class="btn btn-export">Export XLSX</button>
    </div>
  </div>

  <script>
    // TROQUE ESTA URL pela URL real do backend no Render/Railway
    const API_BASE = "https://race-ranking-v0-backend.onrender.com";

    const resultsBody = document.getElementById('results-body');
    const exportBtn = document.getElementById('export-btn');


    function timeStrToSeconds(timeStr) {
      const parts = timeStr.split(':');
      if (parts.length !== 3) return null;
      const [h, m, s] = parts.map(Number);
      if (
        Number.isNaN(h) || Number.isNaN(m) || Number.isNaN(s) ||
        m < 0 || m >= 60 || s < 0 || s >= 60 || h < 0
      ) {
        return null;
      }
      return h * 3600 + m * 60 + s;
    }

    function distanceLabelToKm(label) {
      switch (label) {
        case '5k': return 5.0;
        case '10k': return 10.0;
        case 'HM': return 21.097;
        case 'M': return 42.195;
        default: return null;
      }
    }

    function paceFrom(timeStr, distanceLabel) {
      const secs = timeStrToSeconds(timeStr);
      const km = distanceLabelToKm(distanceLabel);
      if (!secs || !km) return null;
      const secPerKm = secs / km;
      const totalSecs = Math.round(secPerKm);
      const min = Math.floor(totalSecs / 60);
      const sec = totalSecs % 60;
      return `${String(min).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
    }

async function exportToXlsx() {
  if (!exportBtn) return;

  exportBtn.disabled = true;
  exportBtn.textContent = "Exporting...";

  try {
    const response = await fetch(`${API_BASE}/api/races`);
    if (!response.ok) {
      throw new Error("Failed to fetch races for export");
    }
    const data = await response.json();

    if (!data || data.length === 0) {
      alert("No races to export.");
      return;
    }

    // Cabeçalho
    const header = [
      "Date",
      "Event Name",
      "City",
      "Country",
      "Distance",
      "Time",
      "Pace (min/km)"
    ];

    const rows = [];
    rows.push(header);

    data.forEach(race => {
      const pace = paceFrom(race.time_str, race.distance_label) || "";
      rows.push([
        race.date,
        race.event_name,
        race.city,
        race.country,
        race.distance_label,
        race.time_str,
        pace
      ]);
    });

    // Monta CSV (usando ; como separador, fica bem pra Excel em PT-BR também)
    const lines = rows.map(cols =>
      cols
        .map(value => {
          const v = value == null ? "" : String(value);
          // escapa aspas e separador
          const escaped = v.replace(/"/g, '""');
          return `"${escaped}"`;
        })
        .join(";")
    );

    const csvContent = lines.join("\r\n");

    const blob = new Blob([csvContent], {
      type: "application/vnd.ms-excel;charset=utf-8;"
    });

    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    const now = new Date();
    const yyyy = now.getFullYear();
    const mm = String(now.getMonth() + 1).padStart(2, "0");
    const dd = String(now.getDate()).padStart(2, "0");
    const hh = String(now.getHours()).padStart(2, "0");
    const min = String(now.getMinutes()).padStart(2, "0");

    a.href = url;
    a.download = `race-ranking-${yyyy}${mm}${dd}-${hh}${min}.xlsx`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  } catch (err) {
    console.error("Error exporting XLSX:", err);
    alert("Error exporting XLSX. See console for details.");
  } finally {
    exportBtn.disabled = false;
    exportBtn.textContent = "Export XLSX";
  }
}


    
    async function loadRaces() {
      resultsBody.innerHTML =
        '<tr><td colspan="7" class="center">Loading...</td></tr>';
      try {
        const response = await fetch(`${API_BASE}/api/races`);
        console.log('GET /api/races status:', response.status);

        if (!response.ok) throw new Error('Failed to fetch races');
        const data = await response.json();
        console.log('Races received:', data);

        resultsBody.innerHTML = '';
        if (!data || data.length === 0) {
          resultsBody.innerHTML =
            '<tr><td colspan="7" class="center">No races saved yet.</td></tr>';
          return;
        }

        data.forEach(race => {
          const tr = document.createElement('tr');

          const tdDate = document.createElement('td');
          tdDate.textContent = race.date;
          tr.appendChild(tdDate);

          const tdEvent = document.createElement('td');
          tdEvent.textContent = race.event_name;
          tr.appendChild(tdEvent);

          const tdCity = document.createElement('td');
          tdCity.textContent = race.city;
          tr.appendChild(tdCity);

          const tdCountry = document.createElement('td');
          tdCountry.textContent = race.country;
          tr.appendChild(tdCountry);

          const tdDistance = document.createElement('td');
          tdDistance.textContent = race.distance_label;
          tr.appendChild(tdDistance);

          const tdTime = document.createElement('td');
          tdTime.textContent = race.time_str;
          tr.appendChild(tdTime);

          const tdPace = document.createElement('td');
          const pace = paceFrom(race.time_str, race.distance_label);
          tdPace.textContent = pace || '-';
          tr.appendChild(tdPace);

          const tdActions = document.createElement('td');
          const btnDelete = document.createElement('button');
          btnDelete.textContent = 'Delete';
          btnDelete.style.cursor = 'pointer';
          btnDelete.onclick = () => deleteRace(race.id);
          tdActions.appendChild(btnDelete);
          tr.appendChild(tdActions);

          resultsBody.appendChild(tr);
        });
      } catch (err) {
        resultsBody.innerHTML =
          '<tr><td colspan="7" class="center">Error loading races.</td></tr>';
        console.error('Error in loadRaces:', err);
      }
    }

    loadRaces();

if (exportBtn) {
  exportBtn.addEventListener("click", exportToXlsx);
}

    
async function deleteRace(id) {
  const pwd = prompt("Digite a senha para excluir (hint: 333):");
  if (pwd === null) {
    // usuário cancelou
    return;
  }

  if (!pwd.trim()) {
    alert("Senha vazia.");
    return;
  }

  try {
    const response = await fetch(`${API_BASE}/api/races/${id}/delete`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ password: pwd.trim() }),
    });

    if (!response.ok) {
      const errData = await response.json().catch(() => ({}));
      alert(errData.error || "Erro ao excluir corrida.");
      return;
    }

    // sucesso
    await loadRaces();
  } catch (err) {
    console.error("Erro ao excluir corrida:", err);
    alert("Erro ao excluir corrida (ver console).");
  }
}

    
  </script>
</body>
</html>
